//! Filter test output to show only summary lines
//!
//! This plugin intercepts test tool output and extracts just the summary
//! information, making it easier to see pass/fail status at a glance.
//!
//! Supports: cargo test, pytest, jest, go test

/// Register this plugin's hooks
pub fn init() {
    #{
        hooks: [
            #{
                event: "tool_result",
                pattern: "just_test*",
                handler: "filter_test_output",
            }
        ]
    }
}

/// Filter test output to extract summary lines
///
/// Returns the modified event with filtered content, or () to pass through.
pub fn filter_test_output(ctx, event) {
    let text = "";

    // Get text from first content block
    if event.content.len() > 0 {
        let block = event.content[0];
        if block.type == "text" {
            text = block.text;
        }
    }

    if text.len() == 0 {
        return (); // Pass through empty content
    }

    let summary = extract_summary(text);

    if summary.len() > 0 {
        // Return modified event with filtered content
        event.content = [#{ type: "text", text: summary }];
        event
    } else {
        () // Pass through unchanged if no summary found
    }
}

/// Extract test summary from output using simple string matching
fn extract_summary(text) {
    let result = "";

    // Cargo test: look for "test result:" line
    if text.contains("test result:") {
        // Find the test result line
        let lines = text.split('\n');
        for line in lines {
            if line.contains("test result:") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
            // Also include running X tests header
            if line.starts_with("running ") && line.contains(" test") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
            // Include error lines
            if line.starts_with("error[") || line.starts_with("error:") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
        }
    }

    // Pytest: look for "passed in" or "failed in"
    if text.contains("passed in") || text.contains("failed in") {
        let lines = text.split('\n');
        for line in lines {
            // Summary lines typically have "=" prefix and "passed/failed" info
            if line.starts_with("=") && (line.contains("passed") || line.contains("failed")) {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
            // Or lines with time info
            if line.contains(" passed in ") || line.contains(" failed in ") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
        }
    }

    // Jest: look for "Tests:" summary
    if text.contains("Tests:") {
        let lines = text.split('\n');
        for line in lines {
            if line.contains("Tests:") && (line.contains("passed") || line.contains("failed")) {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
            if line.contains("Test Suites:") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
        }
    }

    // Go test: look for "PASS" or "FAIL" at start of line
    if text.starts_with("PASS") || text.starts_with("FAIL") || text.contains("\nPASS") || text.contains("\nFAIL") {
        let lines = text.split('\n');
        for line in lines {
            if line.starts_with("ok ") || line.starts_with("FAIL\t") {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
            if line == "PASS" || line == "FAIL" {
                if result.len() > 0 {
                    result = result + "\n";
                }
                result = result + line;
            }
        }
    }

    result
}
