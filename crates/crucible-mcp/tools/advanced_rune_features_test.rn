/// Test Advanced Rune Language Features
/// Based on official Rune documentation

// Test 1: Struct definition with impl block
struct Person {
    name,
    active,
}

impl Person {
    pub fn new(name) {
        Self { name: name, active: false }
    }

    pub fn set_active(self, active) {
        self.active = active;
    }

    pub fn describe(self) {
        if self.active {
            `Person ${self.name} is active`
        } else {
            `Person ${self.name} is inactive`
        }
    }
}

// Test 2: Module definition
mod tools {
    pub fn create_search_tool() {
        #{
            name: "search_content",
            description: "Search within file contents",
            category: "search"
        }
    }

    pub fn create_file_tool() {
        #{
            name: "create_file",
            description: "Create a new file",
            category: "file"
        }
    }

    pub fn get_all_tools() {
        [
            create_search_tool(),
            create_file_tool()
        ]
    }
}

// Test 3: Pattern matching on struct
pub fn test_pattern_matching(person) {
    match person {
        Person { name: "test", .. } => "Test user detected",
        Person { name, active: true, .. } => `Active user: ${name}`,
        Person { name, .. } => `Inactive user: ${name}`
    }
}

// Test 4: Use modules
pub fn test_modules() {
    let all_tools = tools::get_all_tools();
    let search_tool = tools::create_search_tool();
    #{
        all_tools: all_tools,
        search_tool: search_tool
    }
}

// Test 5: Struct usage
pub fn test_struct() {
    let person = Person::new("test_user");
    let active_person = Person::new("active_user");
    let person_with_status = active_person.set_active(true);

    #{
        person_description: person.describe(),
        active_description: person_with_status.describe(),
        pattern_result: test_pattern_matching(person_with_status)
    }
}

// Tool interface
pub fn NAME() {
    "advanced_rune_features_test"
}

pub fn DESCRIPTION() {
    "Test advanced Rune features: structs, modules, pattern matching"
}

pub fn INPUT_SCHEMA() {
    #{
        type: "object",
        properties: #{
            test_type: #{
                type: "string",
                description: "Type of test to run (struct, module, pattern, all)"
            }
        }
    }
}

pub async fn call(args) {
    let test_type = args.get("test_type").unwrap_or("all");

    match test_type {
        "struct" => #{
            success: true,
            test: "struct",
            result: test_struct()
        },
        "module" => #{
            success: true,
            test: "module",
            result: test_modules()
        },
        "pattern" => #{
            success: true,
            test: "pattern",
            result: test_pattern_matching(Person::new("test"))
        },
        "all" => #{
            success: true,
            test: "all",
            results: #{
                struct_test: test_struct(),
                module_test: test_modules(),
                pattern_test: test_pattern_matching(Person::new("pattern_test"))
            }
        },
        _ => #{
            success: false,
            error: `Unknown test type: ${test_type}`
        }
    }
}