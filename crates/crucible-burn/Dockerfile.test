# Multi-stage Dockerfile for testing crucible-burn

FROM rust:1.75-slim as base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    clang \
    libclang-dev \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy Cargo.toml and lock file
COPY Cargo.toml Cargo.lock ./
COPY crates/crucible-burn/Cargo.toml ./crates/crucible-burn/

# Create dummy source files for caching
RUN mkdir -p crates/crucible-burn/src && \
    echo "fn main() {}" > crates/crucible-burn/src/main.rs && \
    echo "" > crates/crucible-burn/src/lib.rs

# Build dependencies (this layer gets cached)
RUN cargo build --package crucible-burn --all-features && \
    rm -rf target/debug/deps/crucible_burn-* && \
    rm -rf target/debug/crucible-burn

# Test stage
FROM base as test

# Copy the actual source code
COPY . .

# Build the actual project
RUN cargo build --package crucible-burn --all-features

# Run all tests
RUN cargo test --package crucible-burn --all-features

# Performance test stage
FROM test as performance

# Run performance benchmarks
RUN cargo bench --package crucible-burn --features benchmarks

# Security audit stage
FROM base as security

# Install cargo-audit
RUN cargo install cargo-audit

# Copy source and run security audit
COPY . .
RUN cd crates/crucible-burn && cargo audit

# Documentation test stage
FROM test as docs

# Build and test documentation
RUN cargo doc --package crucible-burn --all-features --no-deps
RUN cargo test --package crucible-burn --doc

# Final test image
FROM test

# Install additional test tools
RUN cargo install cargo-nextest

# Set up test environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=debug

# Default command
CMD ["cargo", "nextest", "run", "--package", "crucible-burn", "--all-features"]